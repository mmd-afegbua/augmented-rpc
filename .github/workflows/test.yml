name: Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      clickhouse:
        image: clickhouse/clickhouse-server:latest
        ports:
          - 8123:8123
        env:
          CLICKHOUSE_DB: test_db
          CLICKHOUSE_USER: default
          CLICKHOUSE_PASSWORD: ""
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8123/ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Start application
      run: |
        # Copy test configuration
        cp config.yaml config.test.yaml
        sed -i 's/redis:\/\/localhost:6379/redis:\/\/localhost:6379/g' config.test.yaml
        sed -i 's/http:\/\/localhost:8123/http:\/\/localhost:8123/g' config.test.yaml
        
        # Start application
        CONFIG_FILE=config.test.yaml npm start &
        APP_PID=$!
        
        # Wait for app to start
        sleep 10
        
        # Test basic functionality
        curl -f http://localhost:3000/health
        curl -f http://localhost:3000/metrics
        
        # Test RPC endpoint
        curl -f -X POST http://localhost:3000/ \
          -H "Content-Type: application/json" \
          -d '{"jsonrpc": "2.0", "method": "eth_blockNumber", "params": [], "id": 1}'
        
        # Kill application
        kill $APP_PID

    - name: Run test script
      run: |
        # Make test script executable
        chmod +x test-augmented-rpc.sh
        
        # Set test environment
        export RPC_URL="https://base-mainnet.rpc.x.superfluid.dev"
        
        # Run tests (limit output to avoid overwhelming logs)
        timeout 60 ./test-augmented-rpc.sh | head -100

    - name: Test Docker Compose
      run: |
        # Test docker-compose configuration
        docker-compose config
        
        # Test that services can start
        docker-compose up -d
        
        # Wait for services
        sleep 30
        
        # Test endpoints
        curl -f http://localhost:3000/health
        curl -f http://localhost:3000/metrics
        
        # Test RPC
        curl -f -X POST http://localhost:3000/ \
          -H "Content-Type: application/json" \
          -d '{"jsonrpc": "2.0", "method": "eth_blockNumber", "params": [], "id": 1}'

    - name: Cleanup
      if: always()
      run: |
        docker-compose down -v
        docker system prune -f
